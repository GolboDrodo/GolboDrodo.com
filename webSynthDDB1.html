<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Piano Pro Clean Interface</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 20px; 
            padding-top: 30px;
            user-select: none; 
            background-color: #e0e0e0;
            color: #333;
        }

        /* --- DISPLAY --- */
        .synth-display {
            background-color: #222;
            color: #0f0; 
            font-family: 'Courier New', monospace;
            padding: 10px 20px;
            border-radius: 6px;
            border: 4px solid #444;
            width: 380px; 
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            text-transform: uppercase;
            transition: color 0.3s, border-color 0.3s;
        }

        /* --- GRIGLIA 4x3 --- */
        .container {
            display: grid;
            grid-template-columns: repeat(4, 100px); 
            gap: 12px;                               
        }

        .grid-cell {
            width: 100px;
            height: 90px;
            border-radius: 8px;
            background-color: #fff; 
            border: 2px solid #ccc;
            box-shadow: 0 4px #aaa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 0.05s, box-shadow 0.05s, border-color 0.3s;
        }

        button.grid-cell { cursor: pointer; color: #444; font-weight: bold; }
        
        button.grid-cell:active, button.active-key {
            transform: translateY(3px);
            box-shadow: 0 1px #999;
        }

        /* Note Standard */
        button.note-btn { border-bottom: 4px solid #007bff; }
        button.note-btn.active-key { background-color: #007bff; color: white; border-color: #007bff; }
        
        /* SCALE COLORS */
        button.scale-sharp { background-color: #fffacd; border-bottom-color: #ffcc00; }
        button.scale-sharp.active-key { background-color: #ffcc00; }
        
        button.scale-flat { background-color: #e0ffff; border-bottom-color: #00ced1; }
        button.scale-flat.active-key { background-color: #00ced1; }

        /* Shift Mode */
        button.sharp-mode { background-color: #e0b0ff; border-bottom-color: #9932cc; color: #333; }

        /* Funzioni */
        .func-btn { background-color: #f4f4f4; font-size: 12px; border-bottom: 4px solid #999; }
        button.oct-low { background-color: #cce5ff; border-bottom-color: #004085; color: #004085; }
        button.oct-high { background-color: #d4edda; border-bottom-color: #155724; color: #155724; }

        /* --- KNOBS (PULITI) --- */
        .knob-cell { background-color: #f0f0f0; cursor: ns-resize; border: 2px solid #bbb; }
        
        .knob-circle {
            width: 60px; height: 60px; /* Leggermente più grandi per riempire lo spazio */
            border-radius: 50%;
            background: conic-gradient(#eee, #999, #eee);
            border: 4px solid #555;
            position: relative;
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            pointer-events: none;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .knob-indicator {
            position: absolute; top: 4px; left: 50%;
            width: 5px; height: 18px;
            transform: translateX(-50%);
            border-radius: 2px;
            background-color: #333;
            transition: background-color 0.3s;
        }

        /* Minor Mode Style */
        .minor-mode #knob-scale-rotate .knob-indicator { background-color: #ff0000; }
        .minor-mode #disp-scale { color: #ff4444 !important; }
        .minor-mode .synth-display { border-color: #662222; }
        .minor-mode #knob-scale { border-color: #ffcccc; }

        /* Major Mode Style */
        #knob-scale-rotate .knob-indicator { background-color: #007bff; }

        /* Shift Visual Feedback su Knob Scale */
        .show-shift #knob-scale { border-color: #9932cc; background-color: #e0b0ff; }

        .shortcuts { font-size: 10px; color: #999; position: absolute; top: 5px; left: 5px;}
        .note-main { font-size: 1.4em; }

        /* --- LEGENDA SOTTO --- */
        .controls-legend {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            text-align: center;
            font-size: 0.9em;
            color: #555;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            line-height: 1.8;
            max-width: 400px;
        }
        .legend-title { font-weight: bold; color: #333; display: block; margin-bottom: 5px; border-bottom: 1px solid #eee;}
        kbd {
            background-color: #eee;
            border-radius: 3px;
            border: 1px solid #b4b4b4;
            box-shadow: 0 1px 1px rgba(0,0,0,.2), 0 2px 0 0 rgba(255,255,255,.7) inset;
            color: #333;
            display: inline-block;
            font-size: .85em;
            font-weight: 700;
            line-height: 1;
            padding: 2px 4px;
            white-space: nowrap;
        }
    </style>
</head>
<body id="main-body">

    <div class="synth-display">
        <span id="disp-scale" style="color:white">C MAJOR</span>
        <span id="disp-val">DUR: 0.5s</span>
    </div>

    <div class="container">
        <button id="btn-do" class="grid-cell note-btn" data-note="DO"><span class="shortcuts">1</span><span class="note-main">DO</span></button>
        <button id="btn-re" class="grid-cell note-btn" data-note="RE"><span class="shortcuts">2</span><span class="note-main">RE</span></button>
        <button id="btn-mi" class="grid-cell note-btn" data-note="MI"><span class="shortcuts">3</span><span class="note-main">MI</span></button>
        <button id="btn-fa" class="grid-cell note-btn" data-note="FA"><span class="shortcuts">4</span><span class="note-main">FA</span></button>

        <button id="btn-sol" class="grid-cell note-btn" data-note="SOL"><span class="shortcuts">5</span><span class="note-main">SOL</span></button>
        <button id="btn-la" class="grid-cell note-btn" data-note="LA"><span class="shortcuts">6</span><span class="note-main">LA</span></button>
        <button id="btn-si" class="grid-cell note-btn" data-note="SI"><span class="shortcuts">7</span><span class="note-main">SI</span></button>
        <button id="btn-do-high" class="grid-cell note-btn" data-note="DO_HIGH"><span class="shortcuts">8</span><span class="note-main">DO ↑</span></button>
        
        <button id="btn-octave" class="grid-cell func-btn"><span class="shortcuts">9</span>OCTAVE</button>
        <button id="btn-inst" class="grid-cell func-btn"><span class="shortcuts">0</span>WAVE</button>
        
        <div id="knob-dur" class="grid-cell knob-cell" data-type="dur">
            <div class="knob-circle" id="knob-dur-rotate"><div class="knob-indicator"></div></div>
        </div>

        <div id="knob-scale" class="grid-cell knob-cell" data-type="scale">
            <div class="knob-circle" id="knob-scale-rotate"><div class="knob-indicator"></div></div>
        </div>
    </div>

    <div class="controls-legend">
        <span class="legend-title">CONTROLLI</span>
        <b>Manopola SX</b> (<kbd>←</kbd> / <kbd>→</kbd>): Durata Nota<br>
        <b>Manopola DX</b> (<kbd>↑</kbd> / <kbd>↓</kbd>): Seleziona Scala (Circle of Fifths)<br>
        <kbd>+</kbd> Modo Maggiore | <kbd>-</kbd> Modo Minore<br>
        <kbd>Shift</kbd> (Hold): Inverti Modo (Maj ↔ Min)<br>
        <kbd>0</kbd> Cambia Strumento | <kbd>9</kbd> Cambia Ottava
    </div>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        const masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.5;
        masterGain.connect(audioCtx.destination);

        // --- STATI ---
        let octaveIndex = 0; 
        let isShiftPressed = false; 
        let valDur = 0.2; 
        let isBaseMinorMode = false; // Il modo impostato dal controller (senza shift)

        // --- SCALE ENGINE ---
        let scaleIndex = 0; 
        const minScale = -7;
        const maxScale = 7;

        // Nomi Radici
        const rootNames = {
            0: "C", 1: "G", 2: "D", 3: "A", 4: "E", 5: "B", 6: "F#", 7: "C#",
            "-1": "F", "-2": "Bb", "-3": "Eb", "-4": "Ab", "-5": "Db", "-6": "Gb", "-7": "Cb"
        };

        const waveforms = ['triangle', 'sine', 'square', 'sawtooth'];
        const waveLabels = ['TRIANGLE', 'SINE', 'SQUARE', 'SAWTOOTH'];
        let waveIndex = 0;
        const SEMITONE_RATIO = 1.059463; 
        
        // DOM
        const dispScale = document.getElementById('disp-scale');
        const dispVal = document.getElementById('disp-val');
        const knobScaleRotate = document.getElementById('knob-scale-rotate');
        const knobDurRotate = document.getElementById('knob-dur-rotate');
        const mainBody = document.getElementById('main-body');
        const knobScaleContainer = document.getElementById('knob-scale');

        // --- LOGICA MODALITÀ (XOR) ---
        function isEffectiveMinor() {
            return (isBaseMinorMode !== isShiftPressed);
        }

        // --- LOGICA NOTE ---
        function getNoteModifier(noteName, sIdx) {
            let effectiveIndex = sIdx;
            if (isEffectiveMinor()) {
                effectiveIndex -= 3; 
            }

            const sharpsOrder = ['FA', 'DO', 'SOL', 'RE', 'LA', 'MI', 'SI'];
            const flatsOrder  = ['SI', 'MI', 'LA', 'RE', 'SOL', 'DO', 'FA']; 
            let mod = 0; 

            if (effectiveIndex > 0) {
                for (let i = 0; i < effectiveIndex; i++) {
                    let target = sharpsOrder[i];
                    if (noteName === target) mod = 1;
                    if (target === 'DO' && noteName === 'DO_HIGH') mod = 1;
                }
            }
            else if (effectiveIndex < 0) {
                let count = Math.abs(effectiveIndex);
                for (let i = 0; i < count; i++) {
                    let target = flatsOrder[i];
                    if (noteName === target) mod = -1;
                    if (target === 'DO' && noteName === 'DO_HIGH') mod = -1;
                }
            }
            return mod;
        }

        function playNote(baseFreq, noteName) {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            let freq = baseFreq;
            const mod = getNoteModifier(noteName, scaleIndex);
            
            if (mod === 1) freq *= SEMITONE_RATIO; 
            if (mod === -1) freq /= SEMITONE_RATIO; 
            
            const modes = [1, 0.5, 2]; 
            freq *= modes[octaveIndex];

            const osc = audioCtx.createOscillator();
            const noteGain = audioCtx.createGain();
            osc.type = waveforms[waveIndex];
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            const realDuration = 0.1 + (valDur * 2.9);
            noteGain.gain.setValueAtTime(0.4, audioCtx.currentTime); 
            noteGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + realDuration);
            
            osc.connect(noteGain);
            noteGain.connect(masterGain);
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + realDuration);
            
            setTimeout(() => { osc.disconnect(); noteGain.disconnect(); }, realDuration * 1000 + 100);
        }

        // --- UI ---
        function updateUI() {
            const currentMinor = isEffectiveMinor();
            let root = rootNames[scaleIndex];
            if (!root) root = "?";

            // Gestione visuale MINORE / MAGGIORE
            if (currentMinor) {
                mainBody.classList.add('minor-mode');
                dispScale.textContent = `${root} MINOR`;
            } else {
                mainBody.classList.remove('minor-mode');
                dispScale.textContent = `${root} MAJOR`;
            }

            // Indicatore Shift (Bordo Viola sul Knob Scale)
            if (isShiftPressed) mainBody.classList.add('show-shift');
            else mainBody.classList.remove('show-shift');

            // Colore testo display
            if (!currentMinor) {
                if (scaleIndex === 0) dispScale.style.color = "#fff"; 
                else if (scaleIndex > 0) dispScale.style.color = "#ffcc00"; 
                else dispScale.style.color = "#00ced1"; 
            }

            const deg = scaleIndex * 18; 
            knobScaleRotate.style.transform = `rotate(${deg}deg)`;

            // Aggiorna Tasti
            document.querySelectorAll('.note-btn').forEach(btn => {
                const name = btn.dataset.note;
                const span = btn.querySelector('.note-main');
                
                btn.classList.remove('scale-sharp', 'scale-flat');

                const mod = getNoteModifier(name, scaleIndex);
                
                if (mod === 1) {
                    btn.classList.add('scale-sharp');
                    let label = name.replace('_HIGH','↑') + '#';
                    if (name === 'MI') label = 'MI#'; if (name === 'SI') label = 'SI#';
                    span.textContent = label;
                } 
                else if (mod === -1) {
                    btn.classList.add('scale-flat');
                    let label = name.replace('_HIGH','↑') + 'b';
                    if (name === 'FA') label = 'FAb'; if (name === 'DO'||name==='DO_HIGH') label = 'DOb';
                    span.textContent = label;
                } 
                else {
                    span.textContent = name.replace('_HIGH','↑');
                }
            });
        }

        function updateDurationUI() {
            const sec = 0.1 + (valDur * 2.9);
            dispVal.textContent = "DUR: " + sec.toFixed(1) + "s";
            const deg = -135 + (valDur * 270);
            knobDurRotate.style.transform = `rotate(${deg}deg)`;
        }

        function setBaseMode(mode) {
            if (mode === 'major') isBaseMinorMode = false;
            if (mode === 'minor') isBaseMinorMode = true;
            if (mode === 'toggle') isBaseMinorMode = !isBaseMinorMode;
            updateUI();
        }

        // --- KNOB MOUSE LOGIC ---
        let activeKnob = null; let startY = 0; let startKnobVal = 0; let startScaleVal = 0; 

        document.querySelectorAll('.knob-cell').forEach(k => {
            k.addEventListener('mousedown', (e) => {
                activeKnob = k; startY = e.clientY; 
                document.body.style.cursor = 'ns-resize'; e.preventDefault();
                if (k.dataset.type === 'dur') startKnobVal = valDur;
                if (k.dataset.type === 'scale') startScaleVal = scaleIndex;
            });
            k.addEventListener('dblclick', (e) => {
                if (k.dataset.type === 'scale') setBaseMode('toggle');
            });
        });

        window.addEventListener('mousemove', (e) => {
            if (!activeKnob) return;
            const deltaY = startY - e.clientY; 
            const type = activeKnob.dataset.type;

            if (type === 'dur') {
                const delta = deltaY * 0.01;
                valDur = Math.max(0, Math.min(1, startKnobVal + delta));
                updateDurationUI();
            } 
            if (type === 'scale') {
                const steps = Math.floor(deltaY / 20); 
                let newIdx = startScaleVal + steps;
                if (newIdx > maxScale) newIdx = maxScale;
                if (newIdx < minScale) newIdx = minScale;
                if (newIdx !== scaleIndex) { scaleIndex = newIdx; updateUI(); }
            }
        });

        window.addEventListener('mouseup', () => { activeKnob = null; document.body.style.cursor = 'default'; });

        // --- ALTRI CONTROLLI ---
        function cycleOctave() {
            octaveIndex = (octaveIndex + 1) % 3;
            const labels = ["NORM", "LOW", "HIGH"];
            const btn = document.getElementById('btn-octave');
            btn.innerHTML = `<span class="shortcuts">9</span>OCT: ${labels[octaveIndex]}`;
            btn.classList.remove('oct-low', 'oct-high');
            if(octaveIndex === 1) btn.classList.add('oct-low');
            if(octaveIndex === 2) btn.classList.add('oct-high');
        }

        function cycleWave(dir) {
            waveIndex += dir;
            if (waveIndex >= waveforms.length) waveIndex = 0;
            if (waveIndex < 0) waveIndex = waveforms.length - 1;
            const btn = document.getElementById('btn-inst');
            btn.innerHTML = `<span class="shortcuts">0</span>${waveLabels[waveIndex]}`;
        }

        function triggerVisual(btn) {
            if(!btn) return;
            btn.classList.add('active-key');
            setTimeout(() => btn.classList.remove('active-key'), 100);
        }

        // --- INIT KEYS ---
        const notes = { DO: 261.63, RE: 293.66, MI: 329.63, FA: 349.23, SOL: 392.00, LA: 440.00, SI: 493.88, DO_HIGH: 523.25 };
        const keys = ['DO','RE','MI','FA','SOL','LA','SI','DO_HIGH'];
        const ids = ['btn-do','btn-re','btn-mi','btn-fa','btn-sol','btn-la','btn-si','btn-do-high'];

        ids.forEach((id, i) => document.getElementById(id).addEventListener('mousedown', () => playNote(notes[keys[i]], keys[i])));

        document.getElementById('btn-octave').addEventListener('click', cycleOctave);
        document.getElementById('btn-inst').addEventListener('click', () => cycleWave(1));

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return; 
            if (e.key === 'Shift') { isShiftPressed = true; updateUI(); return; }

            const map = { 'Digit1': 0, 'Digit2': 1, 'Digit3': 2, 'Digit4': 3, 'Digit5': 4, 'Digit6': 5, 'Digit7': 6, 'Digit8': 7 };
            if (map[e.code] !== undefined) {
                const idx = map[e.code];
                playNote(notes[keys[idx]], keys[idx]);
                triggerVisual(document.getElementById(ids[idx]));
            }

            if(e.code === 'Digit9') { cycleOctave(); triggerVisual(document.getElementById('btn-octave')); }
            if(e.code === 'Digit0') { cycleWave(1); triggerVisual(document.getElementById('btn-inst')); }

            // FRECCE SU/GIU (SCALA)
            if (e.code === 'ArrowUp') {
                e.preventDefault();
                if (scaleIndex < maxScale) { scaleIndex++; updateUI(); }
            }
            if (e.code === 'ArrowDown') {
                e.preventDefault();
                if (scaleIndex > minScale) { scaleIndex--; updateUI(); }
            }

            // FRECCE SX/DX (DURATA)
            if (e.code === 'ArrowRight') {
                e.preventDefault();
                valDur = Math.min(1, valDur + 0.05);
                updateDurationUI();
            }
            if (e.code === 'ArrowLeft') {
                e.preventDefault();
                valDur = Math.max(0, valDur - 0.05);
                updateDurationUI();
            }

            // PLUS / MINUS (Maggiore/Minore)
            if (e.key === '+' || e.code === 'NumpadAdd') setBaseMode('major');
            if (e.key === '-' || e.code === 'NumpadSubtract') setBaseMode('minor');
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'Shift') { isShiftPressed = false; updateUI(); }
        });

        // Init
        updateDurationUI();
        updateUI();

    </script>
</body> 
</html>
